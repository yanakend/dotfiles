<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>セキュリティとセーフモード</title>

 </head>
 <body><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="features.safe-mode.html">セーフモード</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="features.safe-mode.functions.html">セーフモードにより制限を受けるか無効となる関数</a></div>
 <div class="up"><a href="features.safe-mode.html">セーフモード</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="ini.sect.safe-mode" class="sect1">
   <h2 class="title">セキュリティとセーフモード</h2>
   <p class="para">
    <table class="doctable table">
     <caption><b>セキュリティとセーフモード設定ディレクティブ</b></caption>
     
      <thead valign="middle">
       <tr valign="middle">
        <th>名前</th>
        <th>デフォルト</th>
        <th>変更の可否</th>
        <th>変更履歴</th>
       </tr>

      </thead>

      <tbody valign="middle" class="tbody">
       <tr valign="middle">
        <td align="left">safe_mode</td>
        <td align="left">&quot;0&quot;</td>
        <td align="left">PHP_INI_SYSTEM</td>
        <td align="left">PHP 5.4.0 で削除されました。</td>
       </tr>

       <tr valign="middle">
        <td align="left">safe_mode_gid</td>
        <td align="left">&quot;0&quot;</td>
        <td align="left">PHP_INI_SYSTEM</td>
        <td align="left">PHP 4.1.0 から利用可能。PHP 5.4.0 で削除されました。</td>
       </tr>

       <tr valign="middle">
        <td align="left">safe_mode_include_dir</td>
        <td align="left">NULL</td>
        <td align="left">PHP_INI_SYSTEM</td>
        <td align="left">PHP 4.1.0 から利用可能。PHP 5.4.0 で削除されました。</td>
       </tr>

       <tr valign="middle">
        <td align="left">safe_mode_exec_dir</td>
        <td align="left">&quot;&quot;</td>
        <td align="left">PHP_INI_SYSTEM</td>
        <td align="left">PHP 5.4.0 で削除されました。</td>
       </tr>

       <tr valign="middle">
        <td align="left">safe_mode_allowed_env_vars</td>
        <td align="left">&quot;PHP_&quot;</td>
        <td align="left">PHP_INI_SYSTEM</td>
        <td align="left">PHP 5.4.0 で削除されました。</td>
       </tr>

       <tr valign="middle">
        <td align="left">safe_mode_protected_env_vars</td>
        <td align="left">&quot;LD_LIBRARY_PATH&quot;</td>
        <td align="left">PHP_INI_SYSTEM</td>
        <td align="left">PHP 5.4.0 で削除されました。</td>
       </tr>

      </tbody>
     
    </table>

    PHP_INI_* モードの詳細および定義については
<a href="configuration.changes.modes.html" class="xref">どこで設定を行うのか</a> を参照してください。
   </p>

   <p class="para">以下に設定ディレクティブに関する
簡単な説明を示します。</p>

   <p class="para">
   セーフモードの設定ディレクティブの簡単な説明を以下に示します。
    <dl>

     <dt id="ini.safe-mode">
      <span class="term">
       <i><tt class="parameter">safe_mode</tt></i>
       <span class="type"><a href="language.types.boolean.html" class="type boolean">boolean</a></span>
      </span>
      <dd>

       <p class="para">
        セーフモードを有効にするか否か。
        PHP が <i>--enable-safe-mode</i> でコンパイルされている場合のデフォルトは
        On、そうでないときのデフォルトは Off です。
       </p>
       <div class="warning"><b class="warning">警告</b><p class="simpara">この機能は PHP 5.3.0 で
<em class="emphasis">非推奨</em>となりました。
この機能を使用しないことを強く推奨します。</p></div>
      </dd>

     </dt>

     <dt id="ini.safe-mode-gid">
      <span class="term">
       <i><tt class="parameter">safe_mode_gid</tt></i>
       <span class="type"><a href="language.types.boolean.html" class="type boolean">boolean</a></span>
      </span>
      <dd>

       <p class="para">
        デフォルトでは、セーフモードはオープンしようとするファイルの
        UIDの比較チェックを行います。GIDの比較にすることでこのチェックを
        緩やかなものにしたい場合、safe_mode_gidをオンにしてください。
        ファイルにアクセスする際に<i>UID</i> (<b><tt>FALSE</tt></b>)を使用するか
        <i>GID</i> (<b><tt>TRUE</tt></b>)を使用するか制御できます。
       </p>
      </dd>

     </dt>

     <dt id="ini.safe-mode-include-dir">
      <span class="term">
       <i><tt class="parameter">safe_mode_include_dir</tt></i>
       <span class="type"><a href="language.types.string.html" class="type string">string</a></span>
      </span>
      <dd>

       <p class="para">
        このディレクトリ（そのサブディレクトリも含む）の配下のファイルが
        インクルードされる場合、<i>UID</i>/<i>GID</i>
        のチェックはバイパスされます。（ディレクトリは
        <a href="ini.core.html#ini.include-path" class="link">include_path</a>の配下であるか
        あるいはフルパスで記述される必要があります）
       </p>
       <span class="simpara">
        PHP 4.2.0以降、このディレクティブは
        <a href="ini.core.html#ini.include-path" class="link">include_path</a>と同様に
        コロン(Windowsではセミコロン)で分けた形式で複数のパスを書くことができます。
       </span>
       <span class="simpara">
        ここで指定される制限は実はプレフィックスでありディレクトリ名ではありません。
        つまり、&quot;<i>safe_mode_include_dir = /dir/incl</i>&quot; と書くと
        &quot;<i>/dir/include</i>&quot; と &quot;<i>/dir/incls</i>&quot;
        の両方へのアクセスが許可されます（もしディレクトリが存在すれば）。
        指定したディレクトリのみを許可したい場合には、最後にスラッシュを追加してください。
        例：&quot;<i>safe_mode_include_dir = /dir/incl/</i>&quot;
       </span>
       <span class="simpara">
        PHP 4.2.3 と PHP 4.3.3 以降では、ディレクティブの値が空の場合、
        異なる <i>UID</i>/<i>GID</i> を持つファイルを
        インクルードすることはできません。
        以前のバージョンでは、全てのファイルをインクルード可能でした。
       </span>
      </dd>

     </dt>

     <dt id="ini.safe-mode-exec-dir">
      <span class="term">
       <i><tt class="parameter">safe_mode_exec_dir</tt></i>
       <span class="type"><a href="language.types.string.html" class="type string">string</a></span>
      </span>
      <dd>

       <p class="para">
        PHPがセーフモードで動作する場合、<span class="function"><a href="function.system.html" class="function">system()</a></span>や
        その他の<a href="ref.exec.html" class="link">プログラム実行関数</a>を、
        このディレクトリ以外で起動することは拒否されます。
        Windowsを含む全ての環境において
        ディレクトリのセパレータとして<i>/</i>を使用する必要があります。
       </p>
      </dd>

     </dt>

     <dt id="ini.safe-mode-allowed-env-vars">
      <span class="term">
       <i><tt class="parameter">safe_mode_allowed_env_vars</tt></i>
       <span class="type"><a href="language.types.string.html" class="type string">string</a></span>
      </span>
      <dd>

       <p class="para">
        ある種の環境変数の設定はセキュリティ上の潜在的な欠陥となりえます。
        このディレクティブにはプレフィックスをカンマで区切って書くことができます。
        セーフモードでは、ここに書かれたプレフィックスで始まる環境変数だけを
        ユーザーが変更できるようになります。デフォルトでは、ユーザーは
        <i>PHP_</i> で始まる名前の環境変数
        (<i>PHP_FOO=BAR</i> など) だけをセットすることができます。
       </p>
       <blockquote class="note"><p><b class="note">注意</b>: 
        <p class="para">
         このディレクティブが空の場合、PHPは全ての環境変数について
         ユーザーが変更することを許可してしまいます。
        </p>
       </p></blockquote>
      </dd>

     </dt>

     <dt id="ini.safe-mode-protected-env-vars">
      <span class="term">
       <i><tt class="parameter">safe_mode_protected_env_vars</tt></i>
       <span class="type"><a href="language.types.string.html" class="type string">string</a></span>
      </span>
      <dd>

       <p class="para">
        <span class="function"><a href="function.putenv.html" class="function">putenv()</a></span>を使ってエンドユーザーが変更するのを
        防ぎたい環境変数をカンマ区切りで記述します。ここで設定された環境変数は
        もしもsafe_mode_allowed_env_varsでは許可されているものであっても
        保護されます。
       </p>
      </dd>

     </dt>

    </dl>

   </p>
   <p class="para">
    <a href="ini.core.html#ini.open-basedir" class="link">open_basedir</a>,
    <a href="ini.core.html#ini.disable-functions" class="link">disable_functions</a>,
    <a href="ini.core.html#ini.disable-classes" class="link">disable_classes</a>,
    <a href="ini.core.html#ini.register-globals" class="link">register_globals</a>,
    <a href="errorfunc.configuration.html#ini.display-errors" class="link">display_errors</a>,
    <a href="errorfunc.configuration.html#ini.log-errors" class="link">log_errors</a>も参照してください。
   </p>

  <p class="para">
   <a href="ini.sect.safe-mode.html#ini.safe-mode" class="link">セーフモード</a>がonの場合、PHPは、
   現在のスクリプトの所有者がファイル関数により処理されているファイルまたはディレクトリ
   の所有者に一致するかどうかを調べます。例えば、
   <div class="example-contents">
<div class="lscode"><pre class="lscode">-rw-rw-r--    1 rasmus   rasmus       33 Jul  1 19:20 script.php
-rw-r--r--    1 root     root       1116 May 26 18:01 /etc/passwd</pre>
</div>
   </div>

    <var class="filename">script.php</var> を実行すると、
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />&nbsp;readfile</span><span style="color: #007700">(</span><span style="color: #DD0000">'/etc/passwd'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

    セーフモードが有効な場合、以下のようなエラーが出力されます。
    <div class="example-contents screen">
<div class="cdata"><pre>
Warning: SAFE MODE Restriction in effect. The script whose uid is 500 is not
allowed to access /etc/passwd owned by uid 0 in /docroot/script.php on line 2
</pre></div>
    </div>
   </p>
   <p class="para">
   <i>UID</i> checking.
    しかし、多くの環境において、厳密な<i>UID</i>チェックは
    適切ではなく、より緩やかな<i>GID</i>チェックで十分です。
    これは<a href="ini.sect.safe-mode.html#ini.safe-mode-gid" class="link">safe_mode_gid</a>スイッチで
    サポートされます。これを<i>On</i>にすると制限の緩い
    <i>GID</i>チェックに、<i>Off</i>（デフォルト）
    にすると<i>UID</i>チェックになります。
  </p>
  <p class="para">
   <a href="ini.sect.safe-mode.html#ini.safe-mode" class="link">safe_mode</a>の代わりに、
   <a href="ini.core.html#ini.open-basedir" class="link">open_basedir</a>ディレクトリを
   セットすると、全てのファイル操作は特定のディレクトリ配下のみに制限されます。
   例えば(Apacheのhttpd.confの例):
   <div class="example-contents">
<div class="inicode"><pre class="inicode">&lt;Directory /docroot&gt;
  php_admin_value open_basedir /docroot
&lt;/Directory&gt;</pre>
</div>
   </div>

   <a href="ini.core.html#ini.open-basedir" class="link">open_basedir</a>でセットしたのと
   同じ <var class="filename">script.php</var> を実行すると、以下のような結果になります:
   <div class="example-contents screen">
<div class="cdata"><pre>
Warning: open_basedir restriction in effect. File is in wrong directory in
/docroot/script.php on line 2
</pre></div>
   </div>
  </p>
  <p class="para">
   特定の関数を無効にすることもできます。
   <a href="ini.core.html#ini.disable-functions" class="link">disable_functions</a>ディレクティブは
   <var class="filename">php.ini</var>以外では使用できないことに注意してください。
   つまり、<var class="filename">httpd.conf</var>上のバーチャルホスト毎あるいはディレクトリ毎に
   関数を無効にすることはできない、ということになります。
   もし<var class="filename">php.ini</var>ファイルに以下を追加した場合:
   <div class="example-contents">
<div class="inicode"><pre class="inicode">disable_functions = readfile,system</pre>
</div>
   </div>

   以下のような結果になります:
   <div class="example-contents screen">
<div class="cdata"><pre>
Warning: readfile() has been disabled for security reasons in
/docroot/script.php on line 2
</pre></div>
   </div>
  </p>
  <div class="warning"><b class="warning">警告</b>
   <p class="para">
    もちろん、これらの PHP の制限はバイナリを実行した場合は有効になりません。
   </p>
  </div>
 </div><hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="features.safe-mode.html">セーフモード</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="features.safe-mode.functions.html">セーフモードにより制限を受けるか無効となる関数</a></div>
 <div class="up"><a href="features.safe-mode.html">セーフモード</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
